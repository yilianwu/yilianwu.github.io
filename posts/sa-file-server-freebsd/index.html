<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=google-site-verification content="ecnbl87JwcfWTJMChfv-5hv5Oui6nsHqvaTr0ha3Mjg"><title>FreeBSD File Server>>[ yilianwu ]</title><link rel="shortcut icon" href=img/favicon.ico><link rel=icon type=image/png href=https://www.yilianwu.io/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.yilianwu.io/favicon-16x16.png sizes=16x16><link rel=stylesheet href=https://www.yilianwu.io/css/styles.css><link rel=stylesheet href=https://www.yilianwu.io/css/font.css></head><body><header><nav class=breadcrumb id=breadcrumb><h4><a href=https://www.yilianwu.io/>[ yilianwu ]</a></h4><a href=https://www.yilianwu.io/info>INFO</a>
<a href=https://www.yilianwu.io/posts>POSTS</a>
<a href=https://www.yilianwu.io/works>WORKS</a></nav><div class=menutime><a id=cd></a>
<a id=ct></a>
<script type=text/javascript src=https://www.yilianwu.io/js/menutime.js></script></div></header><main id=single><div id=post class=white><div class=container><div class=post-toc><div class=post-toc-title><strong>- Contents -</strong></div><div id=page-scrollspy class=toc-nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#file-server>File Server</a></li></ul><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#ftp-server>FTP Server</a></li></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#install-pure-ftpd>Install pure-ftpd</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#create-3-directories-under-homeftp>Create 3 directories under /home/ftp</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#create-admin-user>Create admin user</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#pure-ftpdconf>pure-ftpd.conf</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#create-ftp-users>Create ftp users</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#ssl%e7%b0%bd%e8%ad%89>ssl簽證</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#launch-the-server>Launch the server…</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#test-in-file-zilla>Test in File Zilla</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e6%ac%8a%e9%99%90%e8%a8%ad%e5%ae%9a>權限設定</a></li></ul></ul></ul><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#zfs-on-homeftp>ZFS on /home/ftp</a></li></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#enable-zfs-service>enable ZFS service</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#add-new-hard-disks>Add new hard disks</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#create-mypool>Create mypool</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#mount>Mount</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#automatic-snapshot-script>Automatic snapshot script</a></li></ul></ul></ul><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#ftp-watchd>ftp-watchd</a></li></ul></ul></div></div><div class=paperbg><div id=title><h1>FreeBSD File Server</h1></div><div class=post-meta><span class=post-time>2020-04-18</span><div class=post-tag><a class=tag-link href=https://www.yilianwu.io/tags/freebsd/>FreeBSD</a>
<a class=tag-link href=https://www.yilianwu.io/tags/ftp/>FTP</a>
<a class=tag-link href=https://www.yilianwu.io/tags/nctu/>NCTU</a></div><section class=post-content><h1 id=file-server>File Server&nbsp;<a href=#file-server class=anchor></a></h1><p>Overview:<br>❑ Image that you are a TA of a course, the professor wants you to build a file server that students can submit their homework to<br>❑ To prevent your colleagues from accidentally deleting files on the server, the snapshot and rollback features are needed</p><h2 id=ftp-server>FTP Server&nbsp;<a href=#ftp-server class=anchor></a></h2><h3 id=install-pure-ftpd>Install pure-ftpd&nbsp;<a href=#install-pure-ftpd class=anchor></a></h3><p>Install with pkg</p><pre tabindex=0><code>pkg install pure-ftpd
</code></pre><p>Or install with port</p><pre tabindex=0><code>port install pure-ftpd
</code></pre><p>記得要<br>[x]UPLOADSCRIPT</p><p>enable pure-ftpd</p><pre tabindex=0><code>cat pureftpd_enable=&#34;YES&#34; &gt; /etc/rc.conf
</code></pre><h3 id=create-3-directories-under-homeftp>Create 3 directories under <code>/home/ftp</code>&nbsp;<a href=#create-3-directories-under-homeftp class=anchor></a></h3><pre tabindex=0><code>mkdir -p /home/ftp/public /home/ftp/upload /home/ftp/hidden
</code></pre><h3 id=create-admin-user>Create admin user&nbsp;<a href=#create-admin-user class=anchor></a></h3><p>Create a system user “sysadm”</p><pre tabindex=0><code>adduser
</code></pre><pre tabindex=0><code>user:sysadm  
passwd:W081001  
group:sysadm,wheel  
ssh enable
</code></pre><h3 id=pure-ftpdconf>pure-ftpd.conf&nbsp;<a href=#pure-ftpdconf class=anchor></a></h3><pre tabindex=0><code>cp /usr/local/share/doc/pure-ftpd/pure-ftpd.conf \  
/usr/local/etc/pure-ftpd.conf
</code></pre><p>In pure-ftpd.conf:</p><pre tabindex=0><code>ChrootEveryone  yes
    
AnonymousOnly   no  
  
NoAnonymous     no  
  
PureDB /usr/local/etc/pureftpd.pdb  
   
AnonymousCanCreateDirs  no  
  
AntiWarez   no  
//yes -&gt; Disallow downloads of files owned by the ftp system user  
  
Umask   133:022  
  
AnonymousCantUpload no  
  
CallUploadScript    yes  
  
TLS 1  
</code></pre><h3 id=create-ftp-users>Create ftp users&nbsp;<a href=#create-ftp-users class=anchor></a></h3><ol><li><p>Anonymous</p><pre tabindex=0><code>pw groupadd ftpuser
</code></pre><pre tabindex=0><code>pw useradd ftp -g ftpuser -d /home/ftp
</code></pre></li><li><p>Virtual users<br>Create two virtual users “ftp-vip1”, “ftp-vip2”<br>i. Add a real account</p><pre tabindex=0><code>pw group virtualgroup
</code></pre><pre tabindex=0><code>pw useradd ftpuser1 -g virtualgroup \  
-c &#34;FTP virtual user1&#34; -d /home/ftp \  
-S /sbin/nologin
</code></pre><p>ii. Map a virtual account to a real account</p><pre tabindex=0><code>pure-pw useradd ftp-vip1 -u ftpuser1 -g virtualgroup \  
-d /home/ftp -m
</code></pre></li><li><p>看 user info</p><pre tabindex=0><code>pure-pw show ftp-vip1
</code></pre></li></ol><h3 id=ssl簽證>ssl簽證&nbsp;<a href=#ssl簽證 class=anchor></a></h3><p><img src=https://i.imgur.com/W6tarUL.png alt=Imgur></p><h3 id=launch-the-server>Launch the server&mldr;&nbsp;<a href=#launch-the-server class=anchor></a></h3><p>For testing the server</p><pre tabindex=0><code>/usr/local/sbin/pure-ftpd &amp;
</code></pre><pre tabindex=0><code>ftp localhost
</code></pre><p>Automatically run the server when the system boots<br>add <code>/usr/local/sbin/pure-ftpd &</code> to <code>/etc/rc.d/rc.local</code> or <code>/etc/rc.d/boot.local</code><br>Service</p><pre tabindex=0><code>service pure-ftpd start  
service pure-ftpd stop   
service pure-ftpd restart
</code></pre><p>Service conf location<br><code>/usr/local/etc/rc.d</code> or <code>/etc/rc.d</code></p><h3 id=test-in-file-zilla>Test in File Zilla&nbsp;<a href=#test-in-file-zilla class=anchor></a></h3><p>主機：&lt; your ip address ><br>使用者名稱：&lt; username ><br>passwd：&lt; ******** ><br>port：21</p><h3 id=權限設定>權限設定&nbsp;<a href=#權限設定 class=anchor></a></h3><pre tabindex=0><code>sudo chown sysadm:virtualgroup /home/ftp/upload
sudo chmod 1777 /home/ftp/upload
</code></pre><pre tabindex=0><code>sudo chown sysadm:virtualgroup /home/ftp/public
sudo chmod 777 /home/ftp/public
</code></pre><pre tabindex=0><code>sudo chmod 771 /home/ftp/hidden
sudo mkdir /home/ftp/hidden/treasure
sudo touch /home/ftp/hidden/treasure/secret
</code></pre><p>It would look like this</p><pre tabindex=0><code>drwxrwx--x  2   root    wheel           hidden  
drwxrwxrwx  2   sysadm  virtualgroup    public  
drwxrwxrwt  2   sysadm  virtualgroup    upload  
</code></pre><p>upload的t 表示只有owner/root 才可以刪除檔案/資料夾</p><h2 id=zfs-on-homeftp>ZFS on <code>/home/ftp</code>&nbsp;<a href=#zfs-on-homeftp class=anchor></a></h2><h3 id=enable-zfs-service>enable ZFS service&nbsp;<a href=#enable-zfs-service class=anchor></a></h3><pre tabindex=0><code>cat zfs_enable=&#34;YES&#34; &gt; /etc/rc.conf
</code></pre><pre tabindex=0><code>sudo service zfs start
</code></pre><h3 id=add-new-hard-disks>Add new hard disks&nbsp;<a href=#add-new-hard-disks class=anchor></a></h3><p>VM settings > Storages > add 2 hard disks: ada1 ada2</p><h3 id=create-mypool>Create mypool&nbsp;<a href=#create-mypool class=anchor></a></h3><pre tabindex=0><code>sudo zpool create mypoool mirror /dev/ada1 /dev/ada2
</code></pre><p>檢查</p><pre tabindex=0><code>zpool status
</code></pre><h3 id=mount>Mount&nbsp;<a href=#mount class=anchor></a></h3><pre tabindex=0><code>zfs set mountpoint=/home/ftp mypool
</code></pre><pre tabindex=0><code>zfs set compression=lz4 mypool
</code></pre><pre tabindex=0><code>zfs set atime=off mypool
</code></pre><p>重複上述指令給 <code>mypool/public</code>、<code>mypool/upload</code>、<code>mypool/hidden</code><br>check history</p><pre tabindex=0><code>sudo zpool history
</code></pre><h3 id=automatic-snapshot-script>Automatic snapshot script&nbsp;<a href=#automatic-snapshot-script class=anchor></a></h3><p>Write a script: <code>zbackup</code><br>Usage:<br>- Create: <code>zbackup DATASET [ROTATION_CNT]</code><br>- List: <code>zbackup -l|--list [DATASET|ID|DATASET ID]</code><br>- Delete: <code>zbackup -d|--delete [DATASET|ID|DATASET ID]</code><br>- Export: <code>zbackup -e|--export [DATASET|ID|DATASET ID]</code><br>- Import: <code>zbackup -i|--import FILENAME DATASET</code></p><p><code>$PATH</code>下的filename可以當command執行<br>我的$PATH是 <code>/home/c0846101/bin</code><br><a href=https://github.com/yilianwu/NCTUSA-hw/blob/master/hw3/zbackup>zbackup</a></p><h2 id=ftp-watchd>ftp-watchd&nbsp;<a href=#ftp-watchd class=anchor></a></h2><p>Create ftp-watchd service</p><pre tabindex=0><code>cd /usr/local/etc/rc.d  
sudo vim ftp-watchd  
</code></pre><p><a href=https://github.com/yilianwu/NCTUSA-hw/blob/master/hw3/rc.d/ftp-watchd>ftp-watchd</a></p><pre tabindex=0><code>sudo vim /tmp/uploadscript.sh
</code></pre><p><a href=https://github.com/yilianwu/NCTUSA-hw/blob/master/hw3/tmp/uploadscript.sh>uploadscript.sh</a></p></section></div></div></div></div></main><footer class=sand><a href=https://www.facebook.com/beatboxyilianwu target=_blank><img src=https://i.imgur.com/EJhxgWk.png height=30 width=30></a>
<a href=https://twitter.com/YiLianWu target=_blank><img src=https://i.imgur.com/KvvGcoN.png height=30 width=30></a>
<a href=https://www.instagram.com/weelian/ target=_blank><img src=https://i.imgur.com/FVUwWv0.png height=30 width=30></a>
<a href=https://github.com/yilianwu target=_blank><img src=https://i.imgur.com/BIgEqmF.png height=30 width=30></a>
<a href=https://www.linkedin.com/in/yilianwu/ target=_blank><img src=https://i.imgur.com/hCGvLEq.png height=30 width=30></a>
<span style=display:block class=footer-text>&copy 2019-2025 吳羿璉. All rights reserved. Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a></span></footer><script src=https://code.jquery.com/jquery-latest.js></script>
<script>$(".post-content h1").prepend("§ ")</script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
        displayAlign: "left"
    });
</script><script type=text/javascript src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><link rel=stylesheet href=https://www.yilianwu.io/css/solarized-light.css><script src=https://www.yilianwu.io/js/highlight.pack.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>